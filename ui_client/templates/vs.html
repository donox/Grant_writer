{% extends 'base.html' %}

{% block title %}Wonders and  Worries{% endblock %}

{% block content %}
<!--List to handle selection of a specific vector store -->
<button id="toggleList" class="btn btn-primary">Vector Store List</button>
<div id="listContainer"></div>

<div id="vs1" class="container">
    <div class="row vsName">
        <div class="col-3 lbl">
            <label for="el01" class="col-form-label">Name</label>
        </div>
        <div class="col-7 cntnt">
            <span id="el01" data-name="storeName"></span>
        </div>
        <div class="col update">
            <button type="button" class="updateX">Update Name</button>
        </div>
    </div>
</div>
<div class="row storeID">
    <div class="col-3 lbl">
        <label for="el02" class="col-form-label">ID</label>
    </div>
    <div class="col-7 cntnt">
        <span id="el02" data-name="storeID" class="form-text"></span>
    </div>
    <div class="col update">
        <button type="button" class="update">Update ID</button>
    </div>
</div>

<script>
    let processName = function (element, data) {
        console.log("process Name " + element.text());
    }
    let processID = function (element, data) {
        console.log("process ID " + element.text());
    }
    //Click event handler for Update Button
    let processUpdate = function (data) {
        return function () {
            const row = this.parentElement.parentElement;
            const contentArea = row.querySelector('textarea, span');
            // console.log("CONTENT" + contentArea.outerHTML)
            let ca = $(contentArea);
            let kind = ca.data()['name']
            if (kind == "storeName") {
                processName(ca, data)
            } else if (kind == "storeID") {
                processID(ca, data)
            }
        }
    };

    $(document).ready(function () {
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const storeData = {
            name: urlParams.get('name'),
            id: urlParams.get('store')
        }

        // Assuming you have a button to toggle the list and a container for the list
        const $toggleButton = $('#toggleList');
        const $listContainer = $('#listContainer');
        let isListExpanded = false;
        let selectedItem = null;

        $toggleButton.on('click', function () {
            if (isListExpanded) {
                collapseList();
            } else {
                expandList();
            }
        });

        function expandList() {
            isListExpanded = true;
            $toggleButton.text('Collapse List');
            fetchItems();
        }

        function collapseList() {
            isListExpanded = false;
            $toggleButton.text('Expand List');
            $listContainer.empty();
        }

        function fetchItems() {
            $listContainer.html('<p>Loading...</p>');

            // Replace with your actual API endpoint
            fetch('/get-store-list/')
                .then(response => response.json())
                .then(data => {
                    const $ul = $('<ul class="list-group">');
                    data.forEach(item => {
                        const $li = $(`<li class="list-group-item">${item.name}</li>`);
                        $li.on('click', function () {
                            selectedItem = item;
                            collapseList();
                            // console.log(selectedItem.name);
                            find_and_load_store();
                        });
                        $ul.append($li);
                    });
                    $listContainer.empty().append($ul);
                })
                .catch(error => {
                    console.error('Error fetching items:', error);
                    $listContainer.html('<p>Error loading items. Please try again.</p>');
                });
        }

// Initial setup
        $toggleButton.text('Expand List');


        document.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', processUpdate(storeData))
        })
        $('#el01').text(storeData.name);
        $('#el02').text(storeData.id);


        // updateButtons.addEventListener("click", processUpdate)

        // Adjust height on input event for each textarea
        $('.expandingTextarea').each(function () {
            adjustHeight(this); // Initial adjustment on page load

            $(this).on('input', function () {
                adjustHeight(this);
            });
        });

        let find_and_load_store = function () {
            let data = {id: selectedItem.id};
            fetch('/load-store/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                        $('#el01').text(data['name']);
                        $('#el02').text(data['id']);
                        $('#el03').text(data['instructions']);
                    }
                )
                .catch(error => console.error('Fetch Error(load-store): ' + error))
        };
        // find_and_load_store();

        let load_query_editor = function () {
            // Initialize TinyMCE on the initial textarea
            let base = $('.result')
            let text_area = base.find('.edit-content')

            // Click handler for the query button   ??? IS THIS USED SOMEWHERE???
            // $('.query').on('click', function () {
            //     // Get the content from TinyMCE
            //     let content = encodeURIComponent(text_area.val());
            //     // console.log(content)
            //
            //     let data = {
            //         content: content,
            //         thread: threadName,
            //         user: user,
            //         store: store,
            //     }
            //     console.log("DATA: " + data);
            //     fetch('/query', {
            //         method: 'POST',
            //         headers: {
            //             'Content-Type': 'application/json',
            //         },
            //         body: JSON.stringify(data)
            //     })
            //         .then(response => response.json())
            //         .then(data => {
            //                 if (!Array.isArray(data)) {
            //                     console.log('NOT DATA (OK - empty result.' + data)
            //                 }
            //                 //         // Assuming response is an array of items
            //                 //         // NOT YET WRITTEN
            //             }
            //         )
            //         .catch(error => console.error('Fetch Error (/query): ' + error))
            // });
        };
        // load_query_editor();
    });
</script>

{% endblock %}